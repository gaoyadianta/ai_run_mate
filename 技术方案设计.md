## 🧱 一、整体技术架构（MVP阶段）

```
┌─────────────────────────────────────────────────────────────┐
│                    AI跑伴 RunMate                           │
├─────────────────────────────────────────────────────────────┤
│  Android Kotlin App (基于现有ai-run-mate项目)                │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │   跑步监测   │   AI语音    │   语音交互   │   数据总结   │   │
│  │   模块      │   播报模块   │   模块      │   模块      │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           WebRTC + WebSocket 通信层                     │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↕ (实时语音+数据传输)
┌─────────────────────────────────────────────────────────────┐
│                    Coze AI 智能体平台                        │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │  跑步数据   │   语音识别   │   内容生成   │   语音合成   │   │
│  │  分析工作流  │   (ASR)     │   (LLM)     │   (TTS)     │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 🧩 二、技术方案设计

### ✅ 1. 客户端（Android Kotlin App）
基于现有ai-run-mate/项目，已实现Coze智能体WebRTC语音对话基础功能，需要扩展跑步相关功能：

| 模块 | 技术栈 | 核心功能 |
|------|--------|----------|
| **跑步数据采集层** | `FusedLocationProviderClient`<br/>`SensorManager`<br/>`WorkManager` | • GPS轨迹记录与距离计算<br/>• 步频检测（加速度传感器）<br/>• 配速实时计算<br/>• 后台运行支持 |
| **AI语音交互层** | 现有WebRTC + Coze SDK | • 实时语音播报（定时触发）<br/>• 用户语音输入处理<br/>• 双向语音通信管理 |
| **状态管理层** | `ViewModel` + `LiveData`<br/>`StateFlow` | • 跑步状态流转管理<br/>• UI状态同步<br/>• 数据绑定 |
| **本地存储层** | `Room Database`<br/>`SharedPreferences`<br/>`DataStore` | • 跑步历史记录<br/>• 用户偏好设置<br/>• 离线数据缓存 |
| **UI展示层** | `Jetpack Compose`<br/>`Material Design 3` | • 跑步实时界面<br/>• 数据可视化图表<br/>• 设置与总结页面 |

### ✅ 2. 核心模块设计

#### 🏃‍♂️ 跑步监测模块
```kotlin
// 核心数据结构
data class RunningSession(
    val sessionId: String,
    val startTime: Long,
    val endTime: Long?,
    val totalDistance: Double,
    val totalDuration: Long,
    val averagePace: Double,
    val gpsPoints: List<GpsPoint>,
    val stepCount: Int,
    val calories: Int
)

// 关键服务
class RunningTrackingService : Service() {
    // GPS定位 + 传感器数据采集
    // 实时计算距离、配速、步频
    // 触发AI播报条件检测
}
```

#### 🎙️ AI语音播报模块
```kotlin
// 播报触发器
class AIBroadcastTrigger {
    // 时间触发：每2分钟
    // 距离触发：每1公里
    // 状态触发：配速变化、目标达成
    // 异常触发：掉速过多、心率异常
}

// 数据上报格式
data class RunningDataPayload(
    val currentDistance: Double,
    val currentPace: Double,
    val averagePace: Double,
    val duration: Long,
    val stepFrequency: Int,
    val targetDistance: Double?,
    val userMessage: String? // 用户语音输入
)
```

### ✅ 3. AI交互处理逻辑（Coze智能体配置）

基于现有WebRTC连接，扩展跑步场景的AI工作流：

| 工作流类型 | 触发条件 | 输入数据 | 输出内容 |
|------------|----------|----------|----------|
| **实时播报流** | 定时/条件触发 | 跑步数据 + 上下文 | 鼓励语音 + 专业建议 |
| **用户交互流** | 语音输入 | ASR文本 + 跑步状态 | 针对性回应 |
| **总结生成流** | 跑步结束 | 完整跑步数据 | 总结报告 + 建议 |

---

## 📦 三、任务拆解清单（MVP版本）

### 🧱 第1阶段：基础能力搭建（Day 1-7）

#### Day 1-2: 项目结构搭建
- [ ] 分析现有ai-run-mate项目结构
- [ ] 添加跑步相关依赖库（Location、Sensor、Room等）
- [ ] 设计数据库Schema（跑步记录表、用户设置表）
- [ ] 创建核心数据模型类

#### Day 3-4: GPS定位与轨迹记录
- [ ] 实现GPS定位服务（FusedLocationProvider）
- [ ] 开发轨迹记录算法（距离计算、配速计算）
- [ ] 添加定位权限处理
- [ ] 实现后台运行机制（Foreground Service）

#### Day 5-6: 传感器数据采集
- [ ] 集成加速度传感器（步频检测）
- [ ] 实现步数统计算法
- [ ] 开发数据融合逻辑（GPS + 传感器）

#### Day 7: 基础UI界面
- [ ] 设计跑步主界面（实时数据显示）
- [ ] 实现开始/暂停/结束跑步功能
- [ ] 添加基础的状态管理

### 🧱 第2阶段：AI联动与播报机制（Day 8-14）

#### Day 8-9: 扩展Coze连接
- [ ] 基于现有WebRTC连接，添加跑步数据上报
- [ ] 设计数据传输协议（JSON格式）
- [ ] 实现播报触发器逻辑

#### Day 10-11: AI播报机制
- [ ] 开发定时播报功能（每2分钟/每1公里）
- [ ] 实现条件触发播报（配速变化、目标达成）
- [ ] 添加TTS播放控制

#### Day 12-13: 语音交互功能
- [ ] 集成用户语音输入（基于现有ASR）
- [ ] 实现语音唤醒或按钮触发
- [ ] 开发上下文感知的对话逻辑

#### Day 14: 测试与优化
- [ ] 端到端功能测试
- [ ] 性能优化（电量消耗、内存使用）

### 🧱 第3阶段：总结 + 设置页 + 收尾（Day 15-20）

#### Day 15-16: 跑步总结功能
- [ ] 开发跑步结束总结页
- [ ] 实现AI生成总结语音/文字
- [ ] 添加数据可视化（路线图、配速图）

#### Day 17-18: 用户设置模块
- [ ] 实现AI角色选择（男女声）
- [ ] 添加播报频率设置
- [ ] 开发目标设定功能
- [ ] 权限管理页面

#### Day 19-20: 测试与发布准备
- [ ] 完整功能测试
- [ ] UI/UX优化
- [ ] 性能调优
- [ ] 打包发布

---

## 🧠 四、Coze Bot建议配置

### 🎯 智能体角色设定
```
角色名称：AI跑伴助手
角色描述：专业而温暖的跑步陪伴者，具备运动科学知识和情感支持能力

人设特点：
- 专业：了解跑步训练原理、配速控制、运动生理学
- 温暖：给予鼓励和支持，理解跑者的心理状态
- 适应性：根据用户水平调整建议的专业程度
- 实时性：基于当前跑步数据给出针对性反馈
```

### 🔧 工作流配置

#### 1. 实时播报工作流
```yaml
触发条件: 
  - 定时触发（每2分钟）
  - 距离触发（每1公里）
  - 配速异常（偏离目标±30秒/公里）

输入变量:
  - current_distance: 当前距离
  - current_pace: 当前配速  
  - average_pace: 平均配速
  - target_distance: 目标距离
  - duration: 已跑时间
  - step_frequency: 步频

输出格式:
  - 语音内容（30秒以内）
  - 播报类型（鼓励/建议/提醒）
```

#### 2. 用户交互工作流
```yaml
触发条件: 用户语音输入

输入变量:
  - user_message: 用户语音转文字
  - running_context: 当前跑步状态
  - user_profile: 用户历史数据

输出格式:
  - 回应内容（简洁明了）
  - 建议动作（如调整配速）
```

#### 3. 总结生成工作流
```yaml
触发条件: 跑步结束

输入变量:
  - session_data: 完整跑步数据
  - personal_records: 个人记录对比
  - weather_condition: 天气情况

输出格式:
  - 总结语音（1-2分钟）
  - 文字报告
  - 下次建议
```

### 📝 Prompt模板示例

#### 实时播报Prompt
```
你是一个专业的AI跑步教练，正在陪伴用户跑步。

当前跑步数据：
- 已跑距离：{current_distance}公里
- 当前配速：{current_pace}分钟/公里
- 平均配速：{average_pace}分钟/公里
- 已跑时间：{duration}分钟
- 目标距离：{target_distance}公里

请根据以上数据，生成一段30秒以内的语音播报内容，要求：
1. 语气温暖鼓励
2. 包含具体数据反馈
3. 给出实用建议（如配速调整）
4. 适合跑步时听取

播报内容：
```

---

## 🔧 五、技术实现要点

### 📱 Android端关键技术
1. **后台运行**: 使用Foreground Service确保GPS持续定位
2. **电量优化**: 合理的定位频率设置，避免过度耗电
3. **权限处理**: 精确位置、录音、后台运行权限的用户友好申请
4. **数据同步**: 实时数据与AI服务的可靠传输

### 🤖 AI集成要点
1. **实时性**: WebRTC确保低延迟语音交互
2. **上下文**: 维护跑步会话的完整上下文信息
3. **个性化**: 基于用户历史数据调整AI回应风格
4. **容错性**: 网络异常时的降级处理机制

---
